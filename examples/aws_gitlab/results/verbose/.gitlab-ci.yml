stages:
  - validate
  - publish
  - release

variables:
  AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
  TEMPLATES_BUCKET: ${TEMPLATES_BUCKET}

# Base job configuration for AWS CLI access
.aws_base:
  image: amazon/aws-cli:latest
  before_script:
    - echo "AWS credentials configured via CI/CD variables"
    - aws --version

# Validate CloudFormation template syntax and structure
validate_template:
  extends: .aws_base
  stage: validate
  script:
    - echo "Validating CloudFormation template..."
    - aws cloudformation validate-template
        --template-body file://cfn-templates/s3-bucket.yaml
    - echo "Template validation passed!"
  artifacts:
    reports:
      sast: []
  only:
    - branches
    - tags
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Publish template to S3 distribution bucket
publish_template:
  extends: .aws_base
  stage: publish
  script:
    - echo "Publishing CloudFormation template to S3..."
    - |
      if [ -z "$CI_COMMIT_TAG" ]; then
        echo "Publishing to main branch without tag"
        aws s3 cp cfn-templates/s3-bucket.yaml \
          s3://${TEMPLATES_BUCKET}/templates/s3-bucket-main.yaml \
          --sse AES256 \
          --metadata "git-commit=$CI_COMMIT_SHA,git-branch=$CI_COMMIT_REF_NAME"
      else
        echo "Publishing versioned template with tag: $CI_COMMIT_TAG"
        aws s3 cp cfn-templates/s3-bucket.yaml \
          s3://${TEMPLATES_BUCKET}/templates/s3-bucket-${CI_COMMIT_TAG}.yaml \
          --sse AES256 \
          --metadata "git-commit=$CI_COMMIT_SHA,git-tag=$CI_COMMIT_TAG"

        echo "Publishing as latest..."
        aws s3 cp cfn-templates/s3-bucket.yaml \
          s3://${TEMPLATES_BUCKET}/templates/s3-bucket-latest.yaml \
          --sse AES256 \
          --metadata "git-commit=$CI_COMMIT_SHA,git-tag=$CI_COMMIT_TAG"
      fi
    - echo "Template publishing completed successfully!"
  artifacts:
    paths:
      - cfn-templates/s3-bucket.yaml
    expire_in: 30 days
  only:
    - main
    - tags
  dependencies:
    - validate_template
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Create GitLab release with template artifact
release_template:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: release
  script:
    - echo "Preparing release artifacts..."
    - |
      RELEASE_DESCRIPTION="CloudFormation S3 Bucket Template

      Version: ${CI_COMMIT_TAG}
      Commit: ${CI_COMMIT_SHA}
      Branch: ${CI_COMMIT_REF_NAME}

      Template Features:
      - S3 bucket with versioning enabled
      - Server-side encryption (AES256)
      - Public access block configuration
      - Configurable environment (dev, staging, prod)
      - CloudFormation stack exports

      Published to: s3://${TEMPLATES_BUCKET}/templates/
      - s3-bucket-${CI_COMMIT_TAG}.yaml (versioned)
      - s3-bucket-latest.yaml (latest)"

      echo "$RELEASE_DESCRIPTION"
  release:
    name: CloudFormation Template $CI_COMMIT_TAG
    description: $RELEASE_DESCRIPTION
    tag_name: $CI_COMMIT_TAG
    ref: $CI_COMMIT_TAG
    assets:
      links:
        - name: CloudFormation Template
          url: https://${TEMPLATES_BUCKET}.s3.${AWS_DEFAULT_REGION}.amazonaws.com/templates/s3-bucket-${CI_COMMIT_TAG}.yaml
          link_type: other
  only:
    - tags
  dependencies:
    - publish_template

# Ensure validation runs on merge requests
validate_mr:
  extends: validate_template
  only:
    - merge_requests
  script:
    - echo "Validating template for merge request..."
    - aws cloudformation validate-template
        --template-body file://cfn-templates/s3-bucket.yaml
    - echo "âœ“ Template validation passed for merge request!"
