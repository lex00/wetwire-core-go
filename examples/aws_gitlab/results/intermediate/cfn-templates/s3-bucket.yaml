AWSTemplateFormatVersion: "2010-09-09"
Description: "S3 bucket with versioning, encryption, and public access blocking"

Parameters:
  Environment:
    Type: String
    Description: "Deployment environment"
    Default: "dev"
    AllowedValues:
      - dev
      - staging
      - prod
    ConstraintDescription: "Must be dev, staging, or prod"

  BucketNameSuffix:
    Type: String
    Description: "Suffix for S3 bucket name (e.g., data, logs, artifacts)"
    Default: "data"
    AllowedPattern: "^[a-z0-9-]{1,20}$"
    ConstraintDescription: "Must be 1-20 characters, lowercase letters, numbers, and hyphens only"

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "wetwire-${Environment}-${BucketNameSuffix}-${AWS::AccountId}"
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: "AES256"
            BucketKeyEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Purpose
          Value: "wetwire-storage"
        - Key: ManagedBy
          Value: "CloudFormation"

  PublicAccessBlockConfiguration:
    Type: AWS::S3::PublicAccessBlockConfiguration
    Properties:
      Bucket: !Ref S3Bucket
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true

Outputs:
  BucketName:
    Description: "Name of the S3 bucket"
    Value: !Ref S3Bucket
    Export:
      Name: !Sub "wetwire-bucket-${Environment}-name"

  BucketArn:
    Description: "ARN of the S3 bucket"
    Value: !GetAtt S3Bucket.Arn
    Export:
      Name: !Sub "wetwire-bucket-${Environment}-arn"

  BucketDomainName:
    Description: "Domain name of the S3 bucket"
    Value: !GetAtt S3Bucket.DomainName
    Export:
      Name: !Sub "wetwire-bucket-${Environment}-domain"
