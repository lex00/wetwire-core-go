stages:
  - validate
  - publish
  - release

variables:
  AWS_REGION: "us-east-1"
  CFN_TEMPLATES_BUCKET: "wetwire-cfn-templates-${CI_ENVIRONMENT_NAME}"
  CFN_TEMPLATE_PATH: "cfn-templates/s3-bucket.yaml"

# Validate CloudFormation template syntax and structure
validate:cfn:
  stage: validate
  image: amazon/aws-cli:latest
  script:
    - echo "Validating CloudFormation template..."
    - aws cloudformation validate-template
        --template-body file://${CFN_TEMPLATE_PATH}
        --region ${AWS_REGION}
    - echo "✓ Template validation passed"
  artifacts:
    paths:
      - ${CFN_TEMPLATE_PATH}
    expire_in: 1 day
  only:
    - branches
    - merge_requests
    - tags

# Publish validated template to S3
publish:template:
  stage: publish
  image: amazon/aws-cli:latest
  dependencies:
    - validate:cfn
  script:
    - echo "Publishing CloudFormation template to S3..."
    - TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    - TEMPLATE_KEY="templates/s3-bucket-${CI_COMMIT_SHORT_SHA}-${TIMESTAMP}.yaml"
    - aws s3 cp ${CFN_TEMPLATE_PATH} s3://${CFN_TEMPLATES_BUCKET}/${TEMPLATE_KEY}
        --region ${AWS_REGION}
        --metadata "commit=${CI_COMMIT_SHA},branch=${CI_COMMIT_BRANCH}"
    - echo "Template published to s3://${CFN_TEMPLATES_BUCKET}/${TEMPLATE_KEY}"
    - echo "PUBLISHED_S3_URI=s3://${CFN_TEMPLATES_BUCKET}/${TEMPLATE_KEY}" >> publish.env
  artifacts:
    reports:
      dotenv: publish.env
    expire_in: 1 day
  environment:
    name: ${CI_COMMIT_BRANCH}
  only:
    - branches
    - tags
  except:
    - merge_requests

# Create GitLab release with version tag
release:create:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Creating GitLab release..."
    - VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
    - RELEASE_NAME="S3 Bucket Template - ${VERSION}"
    - RELEASE_DESCRIPTION="CloudFormation S3 bucket template\n\nCommit: ${CI_COMMIT_SHA}\nBranch: ${CI_COMMIT_BRANCH}\nTemplate Path: ${CFN_TEMPLATE_PATH}"
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
        --url "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/releases" \
        --form "tag_name=${VERSION}" \
        --form "name=${RELEASE_NAME}" \
        --form "description=${RELEASE_DESCRIPTION}" \
        --form "released_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
    - echo "✓ Release created: ${RELEASE_NAME}"
  environment:
    name: production
  only:
    - tags
  except:
    - branches
